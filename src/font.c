#include <string.h>

#include "font.h"
#include "utils.h"

#define FONT_SKIPPED 32
#define FONT_STRIDE (128 - FONT_SKIPPED)

// Spleen 8x16, https://github.com/fcambus/spleen
static uint8_t font[FONT_CHAR_HEIGHT * FONT_STRIDE] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x66, 0x00, 0x08, 0x00, 0x00, 0x18, 0x70, 0x0e, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c,
	0x03, 0x3e, 0x08, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x18, 0x0e, 0x00, 0x00,
	0x00, 0x18, 0x66, 0x36, 0x7e, 0x60, 0x1c, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x60, 0x3e, 0x18, 0x3e, 0x3e, 0x03, 0x7f, 0x3e, 0x7f,
	0x3e, 0x3e, 0x00, 0x00, 0x60, 0x00, 0x06, 0x3e, 0x00, 0x3e, 0x3f, 0x7e,
	0x3f, 0x7e, 0x7e, 0x7e, 0x63, 0x7e, 0x7e, 0x63, 0x03, 0x63, 0x63, 0x3e,
	0x3f, 0x3e, 0x3f, 0x7e, 0xff, 0x63, 0x63, 0x63, 0x63, 0x63, 0x7f, 0x0c,
	0x03, 0x30, 0x1c, 0x00, 0x18, 0x00, 0x03, 0x00, 0x60, 0x00, 0x78, 0x00,
	0x03, 0x18, 0x18, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x66, 0x36, 0x0b, 0x66, 0x36, 0x18, 0x0c, 0x30, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x30, 0x63, 0x1c, 0x63, 0x63, 0x03, 0x63, 0x63, 0x63,
	0x63, 0x63, 0x00, 0x00, 0x30, 0x00, 0x0c, 0x63, 0x3e, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x03, 0x63, 0x18, 0x18, 0x63, 0x03, 0x77, 0x63, 0x63,
	0x63, 0x63, 0x63, 0x03, 0x18, 0x63, 0x63, 0x63, 0x63, 0x63, 0x60, 0x0c,
	0x06, 0x30, 0x36, 0x00, 0x30, 0x00, 0x03, 0x00, 0x60, 0x00, 0x0c, 0x00,
	0x03, 0x18, 0x18, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x66, 0x7f, 0x0b, 0x36, 0x36, 0x18, 0x0c, 0x30, 0x66, 0x00,
	0x00, 0x00, 0x00, 0x30, 0x63, 0x1e, 0x60, 0x60, 0x33, 0x03, 0x03, 0x60,
	0x63, 0x63, 0x00, 0x00, 0x18, 0x00, 0x18, 0x60, 0x43, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x03, 0x63, 0x18, 0x18, 0x63, 0x03, 0x7f, 0x67, 0x63,
	0x63, 0x63, 0x63, 0x03, 0x18, 0x63, 0x63, 0x63, 0x63, 0x63, 0x60, 0x0c,
	0x06, 0x30, 0x63, 0x00, 0x00, 0x00, 0x03, 0x00, 0x60, 0x00, 0x0c, 0x00,
	0x03, 0x00, 0x00, 0x03, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x0b, 0x30, 0x36, 0x00, 0x06, 0x60, 0x3c, 0x18,
	0x00, 0x00, 0x00, 0x18, 0x73, 0x1a, 0x60, 0x60, 0x33, 0x03, 0x03, 0x60,
	0x63, 0x63, 0x18, 0x18, 0x0c, 0x7e, 0x30, 0x30, 0x5b, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x03, 0x63, 0x18, 0x18, 0x33, 0x03, 0x6b, 0x67, 0x63,
	0x63, 0x63, 0x63, 0x03, 0x18, 0x63, 0x63, 0x63, 0x36, 0x63, 0x30, 0x0c,
	0x0c, 0x30, 0x00, 0x00, 0x00, 0x3e, 0x3f, 0x7e, 0x7e, 0x7e, 0x0c, 0x7e,
	0x3f, 0x1c, 0x18, 0x33, 0x0c, 0x37, 0x3f, 0x3e, 0x3f, 0x7e, 0x7e, 0x7e,
	0x3e, 0x63, 0x63, 0x63, 0x63, 0x63, 0x7f, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x3e, 0x18, 0x1c, 0x00, 0x06, 0x60, 0x18, 0x18,
	0x00, 0x00, 0x00, 0x18, 0x7b, 0x18, 0x30, 0x3c, 0x33, 0x3f, 0x3f, 0x30,
	0x3e, 0x63, 0x18, 0x18, 0x06, 0x00, 0x60, 0x18, 0x5b, 0x7f, 0x3f, 0x03,
	0x63, 0x1f, 0x1f, 0x7b, 0x7f, 0x18, 0x18, 0x1f, 0x03, 0x63, 0x6b, 0x63,
	0x3f, 0x63, 0x3f, 0x3e, 0x18, 0x63, 0x63, 0x63, 0x1c, 0x7e, 0x18, 0x0c,
	0x0c, 0x30, 0x00, 0x00, 0x00, 0x60, 0x63, 0x03, 0x63, 0x63, 0x3e, 0x63,
	0x63, 0x18, 0x18, 0x1b, 0x0c, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x63, 0x03,
	0x0c, 0x63, 0x63, 0x63, 0x36, 0x63, 0x60, 0x0e, 0x18, 0x70, 0x4c, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x68, 0x18, 0x0e, 0x00, 0x06, 0x60, 0xff, 0x7e,
	0x00, 0x7e, 0x00, 0x0c, 0x6f, 0x18, 0x18, 0x60, 0x33, 0x60, 0x63, 0x18,
	0x63, 0x7e, 0x00, 0x00, 0x06, 0x00, 0x60, 0x0c, 0x5b, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x63, 0x63, 0x18, 0x18, 0x33, 0x03, 0x63, 0x6b, 0x63,
	0x03, 0x63, 0x63, 0x60, 0x18, 0x63, 0x63, 0x63, 0x36, 0x60, 0x0c, 0x0c,
	0x18, 0x30, 0x00, 0x00, 0x00, 0x7e, 0x63, 0x03, 0x63, 0x63, 0x0c, 0x63,
	0x63, 0x18, 0x18, 0x0f, 0x0c, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x03, 0x03,
	0x0c, 0x63, 0x63, 0x6b, 0x1c, 0x63, 0x30, 0x0e, 0x18, 0x70, 0x7e, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x68, 0x0c, 0x5b, 0x00, 0x06, 0x60, 0x18, 0x18,
	0x00, 0x00, 0x00, 0x0c, 0x67, 0x18, 0x0c, 0x60, 0x7f, 0x60, 0x63, 0x0c,
	0x63, 0x60, 0x00, 0x00, 0x0c, 0x7e, 0x30, 0x0c, 0x5b, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x63, 0x63, 0x18, 0x18, 0x63, 0x03, 0x63, 0x73, 0x63,
	0x03, 0x63, 0x63, 0x60, 0x18, 0x63, 0x63, 0x6b, 0x63, 0x60, 0x06, 0x0c,
	0x18, 0x30, 0x00, 0x00, 0x00, 0x63, 0x63, 0x03, 0x63, 0x7f, 0x0c, 0x63,
	0x63, 0x18, 0x18, 0x0f, 0x0c, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x03, 0x3e,
	0x0c, 0x63, 0x63, 0x6b, 0x1c, 0x63, 0x18, 0x18, 0x18, 0x18, 0x32, 0x00,
	0x00, 0x00, 0x00, 0x7f, 0x68, 0x6c, 0x33, 0x00, 0x0c, 0x30, 0x3c, 0x18,
	0x00, 0x00, 0x00, 0x06, 0x63, 0x18, 0x06, 0x60, 0x30, 0x60, 0x63, 0x0c,
	0x63, 0x60, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x7b, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x63, 0x63, 0x18, 0x18, 0x63, 0x03, 0x63, 0x73, 0x63,
	0x03, 0x6b, 0x63, 0x60, 0x18, 0x63, 0x36, 0x7f, 0x63, 0x60, 0x03, 0x0c,
	0x30, 0x30, 0x00, 0x00, 0x00, 0x63, 0x63, 0x03, 0x63, 0x03, 0x0c, 0x63,
	0x63, 0x18, 0x18, 0x1b, 0x0c, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x03, 0x60,
	0x0c, 0x63, 0x36, 0x6b, 0x36, 0x63, 0x0c, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x68, 0x66, 0x33, 0x00, 0x0c, 0x30, 0x66, 0x00,
	0x18, 0x00, 0x18, 0x06, 0x63, 0x18, 0x63, 0x63, 0x30, 0x63, 0x63, 0x0c,
	0x63, 0x63, 0x18, 0x18, 0x30, 0x00, 0x0c, 0x0c, 0x03, 0x63, 0x63, 0x03,
	0x63, 0x03, 0x03, 0x63, 0x63, 0x18, 0x18, 0x63, 0x03, 0x63, 0x63, 0x63,
	0x03, 0x6b, 0x63, 0x60, 0x18, 0x63, 0x1c, 0x77, 0x63, 0x60, 0x03, 0x0c,
	0x30, 0x30, 0x00, 0x00, 0x00, 0x63, 0x63, 0x03, 0x63, 0x03, 0x0c, 0x63,
	0x63, 0x18, 0x18, 0x33, 0x0c, 0x63, 0x63, 0x63, 0x63, 0x63, 0x03, 0x60,
	0x0c, 0x63, 0x1c, 0x6b, 0x63, 0x63, 0x06, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x18, 0x00, 0x36, 0x3f, 0x06, 0x5e, 0x00, 0x18, 0x18, 0x00, 0x00,
	0x18, 0x00, 0x18, 0x03, 0x3e, 0x7e, 0x7f, 0x3e, 0x30, 0x3e, 0x3e, 0x0c,
	0x3e, 0x3e, 0x18, 0x18, 0x60, 0x00, 0x06, 0x0c, 0x3e, 0x63, 0x3f, 0x7e,
	0x3f, 0x7e, 0x03, 0x7e, 0x63, 0x7e, 0x0f, 0x63, 0x7e, 0x63, 0x63, 0x3e,
	0x03, 0x3e, 0x63, 0x3f, 0x18, 0x7e, 0x08, 0x63, 0x63, 0x3f, 0x7f, 0x0c,
	0x60, 0x30, 0x00, 0x00, 0x00, 0x7e, 0x3f, 0x7e, 0x7e, 0x7e, 0x0c, 0x3e,
	0x63, 0x38, 0x18, 0x63, 0x38, 0x63, 0x63, 0x3e, 0x3f, 0x7e, 0x03, 0x3f,
	0x78, 0x7e, 0x08, 0x76, 0x63, 0x7e, 0x7f, 0x18, 0x18, 0x18, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x70, 0x0e, 0x00, 0x00,
	0x0c, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c,
	0x60, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x70, 0x18, 0x0e, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f,
	0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static uint32_t pixel_color2[4] = {
	0x10801080,
	0xeb801080,
	0x1080eb80,
	0xeb80eb80,
};

size_t font_encode(const char* str, size_t y, uint32_t* pixbuf) {
	uint32_t* pixel = pixbuf;
	uint8_t* tmp = font + y * FONT_STRIDE - FONT_SKIPPED;

	while(*str) {
		uint32_t f = tmp[(size_t)(*(str++))] << 2;

		for(size_t i = 0; i < FONT_CHAR_WIDTH / 2; i++) {
			*(pixel++) = *(uint32_t*)((uintptr_t)pixel_color2 + (f & 12));
			f >>= 2;
		}
	}

	return pixel - pixbuf;
}

size_t font_width(const char* str) {
	return strlen(str) * FONT_CHAR_WIDTH / 2;
}